export default {
  async fetch(request, env) {
    const ALLOW_ORIGIN = "https://solutionalkarol.github.io"; // <- Twoja domena Pages
    const cors = {
      "Access-Control-Allow-Origin": ALLOW_ORIGIN,
      "Access-Control-Allow-Methods": "POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type, Authorization",
    };
    if (request.method === "OPTIONS") return new Response(null, { headers: cors });
    if (request.method !== "POST") return new Response("Method Not Allowed", { status: 405, headers: cors });

    try {
      const { messages = [], max_output_tokens = 600 } = await request.json();
      const system = {
        role: "system",
        content: [
          "Jesteś asystentem Naukowego Centrum Neuroróżnorodności.",
          "Mówisz krótko, jasno, po polsku, ciepłym i profesjonalnym tonem.",
          "Jeśli pytanie dotyczy zapisu/terminu/ceny – zaproponuj zostawienie kontaktu (imię + e-mail).",
          "Charakter oferty: edukacyjny/well-being; nie diagnozujemy i nie prowadzimy terapii klinicznej.",
          "Ścieżki: VR (ból/stres/sen/koncentracja), edukacja (kursy, certyfikat), mentoring (1:1 lub grupowy), neurofeedback (char. eduk.).",
          "Jeśli nie masz pewności – powiedz to wprost i zaproponuj kontakt e-mail.",
        ].join(" "),
      };

      const payload = {
        model: "gpt-4o-mini",
        messages: [system, ...messages],
        max_output_tokens,
        temperature: 0.4,
      };

      const r = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${env.OPENAI_API_KEY}`,
        },
        body: JSON.stringify(payload),
      });

      if (!r.ok) {
        const err = await r.text();
        return new Response(JSON.stringify({ error: err }), { status: 500, headers: { "Content-Type": "application/json", ...cors } });
      }
      const data = await r.json();
      const reply = data?.choices?.[0]?.message?.content?.trim() || "Przepraszam, nie mam teraz odpowiedzi.";
      return new Response(JSON.stringify({ reply }), { headers: { "Content-Type": "application/json", ...cors } });
    } catch (e) {
      return new Response(JSON.stringify({ error: e.message || "Proxy error" }), { status: 500, headers: { "Content-Type": "application/json", ...cors } });
    }
  },
};
